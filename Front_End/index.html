<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DoDate</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/pulse/bootstrap.min.css">

  <style>
    :root { --dodate-purple: #593196; }

    .progress-btn{
      width:20px;height:20px;border-radius:50%;
      background:transparent;cursor:pointer;display:inline-block;
      border:1px solid #6c757d;
    }
    .progress-btn.started{ border:3px solid var(--dodate-purple); }
    .progress-btn.completed{
      background-color: var(--dodate-purple);
      border:2px solid var(--dodate-purple);
    }

    .focus-btn{
      cursor:pointer;
      color:#6c757d;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .focus-btn.active{ color: var(--dodate-purple); }

    .task-details { background: #ffffff; }
    .task-details .small-muted { color: #6c757d; }

    .step-item {
      display:flex;
      align-items:center;
      gap:.5rem;
      padding:.15rem 0;
    }
    .step-status {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:22px;
      height:22px;
      border-radius:50%;
      border:1px solid #6c757d;
      color:#6c757d;
      flex:0 0 auto;
    }
    .step-status.started { border:2px solid var(--dodate-purple); color: var(--dodate-purple); }
    .step-status.completed { background: var(--dodate-purple); border:2px solid var(--dodate-purple); color:#fff; }
    .step-text.completed { text-decoration: line-through; opacity:.75; }
  </style>
</head>

<body class="bg-light">

  <nav class="navbar navbar-expand-lg bg-primary" data-bs-theme="dark">
    <div class="container-xl">
      <a class="navbar-brand" href="#"><i class="bi bi-check2-square me-2"></i>DoDate</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01"
              aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarColor01">
        <ul class="navbar-nav me-auto gap-1" id="navCategories"></ul>

        <div class="d-flex gap-2">
          <button class="btn btn-light btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#modalNewTask">
            <i class="bi bi-plus-lg me-1"></i>Task
          </button>

          <button class="btn btn-outline-light btn-sm" type="button" id="btnReload">
            <i class="bi bi-arrow-clockwise me-1"></i>Reload
          </button>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-xl py-3">
    <div id="divError" class="alert alert-danger d-none" role="alert"></div>

    <!-- Stat Cards REMOVED -->

    <div id="secCalendarFocus">
      <div class="row g-3 mt-1 align-items-stretch">

        <!-- LEFT: Calendar -->
        <div class="col-12 col-lg-7">
          <div class="card shadow-sm border-0 rounded-3 h-100">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h5 class="m-0"><i class="bi bi-calendar3 me-2 text-primary"></i>Calendar</h5>
                <span class="text-muted small">Tasks + Events</span>
              </div>
              <div id="divCalendar"></div>
            </div>
          </div>
        </div>

        <!-- RIGHT: Today’s Focus only (Incomplete by Category REMOVED) -->
        <div class="col-12 col-lg-5">
          <div class="d-flex flex-column gap-3 h-100">

            <!-- Today’s Focus -->
            <div class="card shadow-sm border-0 rounded-3 flex-grow-1">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <h5 class="m-0"><i class="bi bi-alarm me-2 text-primary"></i>Today’s Focus</h5>
                  <span class="badge bg-primary-subtle text-primary" id="badgeFocusCount">0</span>
                </div>

                <div class="table-responsive">
                  <table class="table table-sm align-middle mb-0" id="tblFocus" style="table-layout: fixed; width: 100%;">
                    <thead class="table-light">
                      <tr>
                        <th style="width:45%;">Task / Event</th>
                        <th style="width:25%;">Category</th>
                        <th style="width:20%;">Due/Date</th>
                        <th style="width:10%;">Size</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>

              </div>
            </div>

          </div>
        </div>

      </div>
    </div>

    <div id="secLists">
      <h4 class="mt-3 mb-2 d-none" id="pageTitle"></h4>

      <!-- Task List -->
      <div class="card shadow-sm border-0 rounded-3 mt-3">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
            <h5 class="m-0"><i class="bi bi-clipboard2-check me-2 text-primary"></i>Task List</h5>
            <div class="d-flex gap-2">
              <input class="form-control form-control-sm" id="txtTaskSearch" type="text" placeholder="Search (draft)" disabled>
              <button class="btn btn-outline-primary btn-sm" type="button" disabled>
                <i class="bi bi-funnel me-1"></i>Filter
              </button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="tblTasks" style="table-layout: fixed; width: 100%;">
              <thead class="table-light">
                <tr>
                  <th style="width:40px;"></th>
                  <th>Task</th>
                  <th style="width:160px;">Category</th>
                  <th class="text-center" style="width:60px;"><i class="bi bi-brightness-high"></i></th>
                  <th style="width:190px;">Due</th>
                  <th style="width:90px;">Size</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Events (READ ONLY) -->
      <div class="card shadow-sm border-0 rounded-3 mt-3">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h5 class="m-0"><i class="bi bi-person-arms-up me-2 text-primary"></i>Events</h5>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="tblEvents">
              <thead class="table-light">
                <tr>
                  <th>Name</th>
                  <th style="width:140px;">Category</th>
                  <th style="width:220px;">Date & Time</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- New Task Modal (kept) -->
  <div class="modal fade" id="modalNewTask" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-clipboard2-plus me-2"></i>New Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-7">
              <label class="form-label">Task Name</label>
              <input class="form-control" id="newTaskName">
            </div>

            <div class="col-12 col-md-5">
              <label class="form-label">Category</label>
              <select class="form-select" id="newTaskCategory"></select>
            </div>

            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="newTaskDesc" rows="3"></textarea>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Due Date</label>
              <input class="form-control" id="newTaskDue" type="date">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Size</label>
              <select class="form-select" id="newTaskWeight">
                <option value="1">1 (Tiny)</option>
                <option value="2">2 (Small)</option>
                <option value="3" selected>3 (Medium)</option>
                <option value="4">4 (Large)</option>
                <option value="5">5 (Huge)</option>
              </select>
            </div>

            <div class="col-12 col-md-4 d-flex align-items-end">
              <div class="d-flex align-items-center gap-2">
                <input class="form-check-input d-none" type="checkbox" id="newTaskFocus">
                <span class="focus-btn" id="newTaskFocusBtn" role="button" title="Toggle Today’s Focus">
                  <i class="bi bi-brightness-high"></i>
                </span>
                <span class="small">Today’s Focus</span>
              </div>
            </div>

          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="btnCreateTask">Create Task</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Event/New Event/Edit Task/Edit Event/Categories modals REMOVED -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
          crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/index.global.min.js"></script>

  <script>
  const strBaseURL = "/";

  function $(sel) { return document.querySelector(sel); }

  let cacheTasks = [];
  let cacheEvents = [];
  let cacheCategories = [];

  let currentCategory = null;
  let viewMode = "dashboard";
  let statFilter = null;

  function escapeHtml(s) {
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function setViewMode(mode) {
    viewMode = mode;

    // stat cards removed, so only hide/show calendar+focus on dashboard
    const showDashboardWidgets = (mode === "dashboard");
    $("#secCalendarFocus").classList.toggle("d-none", !showDashboardWidgets);
    $("#secLists").classList.remove("d-none");
  }

  function setPageTitle(text) {
    const el = $("#pageTitle");
    if (!text) { el.textContent=""; el.classList.add("d-none"); return; }
    el.textContent = text;
    el.classList.remove("d-none");
  }

  function showError(msg) {
    const div = $("#divError");
    div.textContent = msg;
    div.classList.remove("d-none");
  }

  function clearError() {
    $("#divError").classList.add("d-none");
    $("#divError").textContent = "";
  }

  function clearTables() {
    $("#tblTasks tbody").innerHTML = "";
    $("#tblFocus tbody").innerHTML = "";
    $("#tblEvents tbody").innerHTML = "";
  }

  function parseDateOnly(dateStr) {
    if (!dateStr) return null;
    let s = String(dateStr).trim();
    if (!s) return null;

    const m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if (m) {
      const y = m[1];
      const mo = m[2].padStart(2, "0");
      const d = m[3].padStart(2, "0");
      s = `${y}-${mo}-${d}`;
    }

    s = s.replace(" ", "T");

    let d1 = new Date(s.length === 10 ? (s + "T00:00:00") : s);
    if (!Number.isNaN(d1.getTime())) {
      return new Date(d1.getFullYear(), d1.getMonth(), d1.getDate());
    }

    const m2 = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (m2) {
      const mo = Number(m2[1]) - 1;
      const day = Number(m2[2]);
      const yr = Number(m2[3]);
      const d2 = new Date(yr, mo, day);
      return Number.isNaN(d2.getTime()) ? null : d2;
    }

    return null;
  }

  // Steps DISPLAY ONLY (no buttons, no API calls)
  function renderStepsHtml(steps) {
    const list = Array.isArray(steps) ? steps : [];
    if (list.length === 0) return `<div class="small-muted">No steps yet.</div>`;

    return list.map((st) => {
      const status = (st.status ?? "incomplete").toLowerCase();

      let cls = "step-status";
      let icon = "bi-circle";
      let textCls = "step-text";

      if (status === "started") { cls += " started"; icon = "bi-circle-half"; }
      if (status === "completed") { cls += " completed"; icon = "bi-check-lg"; textCls += " completed"; }

      return `
        <div class="step-item">
          <span class="${cls}" title="${escapeHtml(status)}">
            <i class="bi ${icon}"></i>
          </span>
          <span class="${textCls}">${escapeHtml(st.step ?? "")}</span>
        </div>
      `;
    }).join("");
  }

  function addTaskRow(task, tableId, taskIndex = null) {
    const isMain = (tableId === "#tblTasks");
    let row = "<tr>";

    if (isMain) {
      const status = (task.status ?? "").toLowerCase();
      let className = "progress-btn";
      if (status === "started" || status === "in progress") className += " started";
      if (status === "completed") className += " completed";

      row += `
        <td class="text-center">
          <span class="${className}" data-index="${taskIndex}" title="Cycle status"></span>
        </td>
      `;
    }

    if (isMain) {
      row += `
        <td class="text-wrap">
          <a href="#"
             class="text-decoration-none"
             data-bs-toggle="collapse"
             data-bs-target="#taskDetails_${taskIndex}"
             aria-expanded="false">
            ${escapeHtml(task.task_name ?? "")}
          </a>
        </td>
      `;
    } else {
      row += `<td class="text-wrap">${escapeHtml(task.task_name ?? "")}</td>`;
    }

    row += `<td class="text-wrap">${escapeHtml(task.category_name ?? "")}</td>`;

    if (isMain) {
      const isFocus = !!task.todays_focus;
      const focusClass = isFocus ? "focus-btn active" : "focus-btn";
      const iconClass = isFocus ? "bi-brightness-high-fill" : "bi-brightness-high";

      row += `
        <td class="text-center">
          <span class="${focusClass}" data-index="${taskIndex}" title="Toggle Today's Focus">
            <i class="bi ${iconClass}"></i>
          </span>
        </td>
      `;
    }

    row += `<td>${escapeHtml(task.due_date ?? "")}</td>`;
    row += `<td>${escapeHtml(task.weight ?? "")}</td>`;
    row += "</tr>";

    $(tableId + " tbody").innerHTML += row;

    if (isMain) {
      const detailsRow = `
        <tr class="task-details">
          <td colspan="6" class="p-0 border-0">
            <div class="collapse" id="taskDetails_${taskIndex}">
              <div class="p-3 border-top">
                <div class="mb-3">
                  <div class="fw-semibold">Description</div>
                  <div class="small-muted">${escapeHtml(task.description ?? "") || "—"}</div>
                </div>

                <div class="mb-2">
                  <div class="fw-semibold">Steps</div>
                  <div class="mt-2" id="stepsWrap_${taskIndex}">
                    ${renderStepsHtml(task.steps)}
                  </div>
                </div>

              </div>
            </div>
          </td>
        </tr>
      `;
      $("#tblTasks tbody").innerHTML += detailsRow;
    }
  }

  // Events are READ ONLY (no expand/edit/delete buttons)
  // FIXED: use backend keys (event_name, category_name, start_time, end_time, description)
  function addEventRow(event, eventIndex) {
    let row = "<tr>";
    row += `<td class="text-wrap">${escapeHtml(event.event_name ?? "")}</td>`;
    row += `<td>${escapeHtml(event.category_name ?? "")}</td>`;
    row += `<td><i class="bi bi-calendar-event me-2 text-primary"></i>${escapeHtml(event.date ?? "")} <i class="bi bi-clock ms-3 me-2 text-primary"></i>${escapeHtml(event.start_time ?? "")}-${escapeHtml(event.end_time ?? "")}</td>`;
    row += `<td>${escapeHtml(event.description ?? "")}</td>`;
    row += "</tr>";
    $("#tblEvents tbody").innerHTML += row;
  }

  async function cycleTaskStatus(taskIndex, dotEl) {
    clearError();
    dotEl.style.pointerEvents = "none";
    dotEl.style.opacity = "0.6";

    try {
      const res = await fetch(strBaseURL + `tasks/${taskIndex}/status`, { method: "PATCH" });
      if (!res.ok) throw new Error("Failed to update task status");

      let newStatus = null;
      try { newStatus = (await res.json()).status?.toLowerCase(); } catch {}

      dotEl.classList.remove("started", "completed");
      if (newStatus === "started" || newStatus === "in progress") dotEl.classList.add("started");
      if (newStatus === "completed") dotEl.classList.add("completed");

      await loadDashboard();
    } catch (err) {
      showError(err.message || "Update error");
    } finally {
      dotEl.style.pointerEvents = "";
      dotEl.style.opacity = "";
    }
  }

  async function toggleTaskFocus(taskIndex, el) {
    clearError();
    el.style.pointerEvents = "none";
    el.style.opacity = "0.6";

    try {
      const res = await fetch(strBaseURL + `tasks/${taskIndex}/focus`, { method: "PATCH" });
      if (!res.ok) throw new Error("Failed to update focus");

      const data = await res.json();
      const isFocus = !!data.todays_focus;

      el.classList.toggle("active", isFocus);
      const icon = el.querySelector("i");
      icon.classList.remove("bi-brightness-high", "bi-brightness-high-fill");
      icon.classList.add(isFocus ? "bi-brightness-high-fill" : "bi-brightness-high");

      await loadDashboard();
    } catch (err) {
      showError(err.message || "Focus update error");
    } finally {
      el.style.pointerEvents = "";
      el.style.opacity = "";
    }
  }

  function fillCategorySelect(selectEl, categories) {
    selectEl.innerHTML = "";
    categories.forEach(c => {
      const name = c.category_name ?? "";
      if (!name.trim()) return;
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      selectEl.appendChild(opt);
    });
  }

  async function loadCategoriesForModals() {
    try {
      const res = await fetch(strBaseURL + "categories");
      if (!res.ok) return;
      cacheCategories = await res.json();
      fillCategorySelect($("#newTaskCategory"), cacheCategories);
    } catch {}
  }

  function setSunToggle(btnEl, checkboxEl, isOn) {
    btnEl.classList.toggle("active", isOn);
    const icon = btnEl.querySelector("i");
    icon.classList.remove("bi-brightness-high", "bi-brightness-high-fill");
    icon.classList.add(isOn ? "bi-brightness-high-fill" : "bi-brightness-high");
    checkboxEl.checked = isOn;
  }

  // New Task sun toggle
  $("#newTaskFocusBtn").addEventListener("click", () => {
    setSunToggle($("#newTaskFocusBtn"), $("#newTaskFocus"), !$("#newTaskFocus").checked);
  });

  // Task table click handling (ONLY status + focus)
  $("#tblTasks").addEventListener("click", (ev) => {
    const dot = ev.target.closest(".progress-btn");
    if (dot) {
      const idx = Number(dot.getAttribute("data-index"));
      if (!Number.isNaN(idx)) cycleTaskStatus(idx, dot);
      return;
    }

    const focusBtn = ev.target.closest(".focus-btn");
    if (focusBtn && focusBtn.hasAttribute("data-index")) {
      const idx = Number(focusBtn.getAttribute("data-index"));
      if (!Number.isNaN(idx)) toggleTaskFocus(idx, focusBtn);
      return;
    }
  });

  function setStats({ focusCount }) {
    $("#badgeFocusCount").textContent = focusCount;
  }

  function renderCalendar(taskEvents, eventEvents) {
    const calendarEl = $("#divCalendar");
    calendarEl.innerHTML = "";
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      height: "auto",
      events: taskEvents.concat(eventEvents),
    });
    calendar.render();
  }

  function renderCategories(categories) {
    const ul = $("#navCategories");
    ul.innerHTML = "";

    const makeLink = (label, mode, catValue = null) => {
      const li = document.createElement("li");
      li.className = "nav-item";

      const active =
        (mode === "dashboard" && viewMode === "dashboard") ||
        (mode === "all" && viewMode === "all") ||
        (mode === "category" && currentCategory === catValue);

      li.innerHTML = `
        <a class="nav-link ${active ? "active" : ""}"
           href="#"
           data-mode="${mode}"
           data-cat="${catValue ?? ""}">
           ${escapeHtml(label)}
        </a>
      `;
      ul.appendChild(li);
    };

    makeLink("Dashboard", "dashboard");
    makeLink("All", "all");

    categories.forEach(c => {
      const name = c.category_name ?? "";
      if (name.trim() !== "") makeLink(name, "category", name);
    });

    ul.querySelectorAll("a[data-mode]").forEach(a => {
      a.addEventListener("click", (ev) => {
        ev.preventDefault();
        statFilter = null;
        setPageTitle(null);

        const mode = a.getAttribute("data-mode");
        const cat = a.getAttribute("data-cat");

        if (mode === "dashboard") { currentCategory = null; setViewMode("dashboard"); }
        if (mode === "all") { currentCategory = null; setViewMode("all"); }
        if (mode === "category") { currentCategory = cat; setViewMode("category"); }

        loadDashboard();
      });
    });
  }

  async function loadDashboard() {
    clearError();
    clearTables();

    try {
      const [catsRes, eventsRes, tasksRes] = await Promise.all([
        fetch(strBaseURL + "categories"),
        fetch(strBaseURL + "events"),
        fetch(strBaseURL + "tasks"),
      ]);

      if (!catsRes.ok) throw new Error("Failed to load /categories");
      if (!eventsRes.ok) throw new Error("Failed to load /events");
      if (!tasksRes.ok) throw new Error("Failed to load /tasks");

      const categories = await catsRes.json();
      const allEventsRaw = await eventsRes.json();
      const allTasksRaw = await tasksRes.json();

      cacheCategories = categories;

      const allTasks = allTasksRaw.map((t, idx) => ({ ...t, _index: idx }));
      const allEvents = allEventsRaw.map((e, idx) => ({ ...e, _index: idx }));

      cacheTasks = allTasks;
      cacheEvents = allEvents;

      renderCategories(categories);

      let events = allEvents;
      let tasks = allTasks;

      // FIXED: category filter uses backend key category_name
      if (viewMode === "category" && currentCategory) {
        events = allEvents.filter(e => (e.category_name ?? "") === currentCategory);
        tasks  = allTasks.filter(t => (t.category_name ?? "") === currentCategory);
      }

      const today = new Date();
      const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());

      // Focus
      let focusCount = 0;
      const focusTaskIndexes = new Set();

      const taskEvents = [];
      const eventEvents = [];

      // Events (read-only render + focus + calendar)
      events.forEach(e => {
        addEventRow(e, e._index);

        const eventDate = parseDateOnly(e.date);

        // FIXED: Focus row uses backend keys
        if (eventDate && eventDate.getTime() === todayDateOnly.getTime()) {
          $("#tblFocus tbody").innerHTML += `
            <tr>
              <td>${escapeHtml(e.event_name ?? "")}</td>
              <td>${escapeHtml(e.category_name ?? "")}</td>
              <td>${escapeHtml(e.date ?? "")}</td>
              <td>—</td>
            </tr>
          `;
        }

        // FIXED: Calendar uses backend keys
        if (e.date && e.start_time) {
          eventEvents.push({
            title: e.event_name ?? "",
            start: (e.date ?? "") + "T" + (e.start_time ?? "00:00"),
            end: (e.date ?? "") + "T" + (e.end_time ?? e.start_time ?? "00:00"),
          });
        }
      });

      // Sort tasks by category in All view only (unchanged behavior)
      if (viewMode === "all") {
        tasks = [...tasks].sort((a, b) => {
          const catA = (a.category_name ?? "").toLowerCase();
          const catB = (b.category_name ?? "").toLowerCase();
          if (catA < catB) return -1;
          if (catA > catB) return 1;

          const dueA = parseDateOnly(a.due_date) ?? new Date(9999, 0, 1);
          const dueB = parseDateOnly(b.due_date) ?? new Date(9999, 0, 1);
          return dueA - dueB;
        });
      }

      tasks.forEach(t => {
        addTaskRow(t, "#tblTasks", t._index);

        const status = (t.status ?? "").toLowerCase();
        const due = parseDateOnly(t.due_date);

        if (due && status !== "completed") {
          taskEvents.push({
            title: t.task_name ?? "",
            start: due.toISOString().split("T")[0],
          });
        }

        const isManualFocus = !!t.todays_focus;
        const isDueToday = due && due.getTime() === todayDateOnly.getTime() && status !== "completed";

        if (isManualFocus || isDueToday) {
          if (!focusTaskIndexes.has(t._index)) {
            focusTaskIndexes.add(t._index);
            focusCount++;

            const focusTag = isManualFocus
              ? `<i class="bi bi-brightness-high-fill ms-2" style="color: var(--dodate-purple)"></i>`
              : `<span class="badge bg-primary-subtle text-primary ms-2">Due Today</span>`;

            $("#tblFocus tbody").innerHTML += `
              <tr>
                <td>${escapeHtml(t.task_name ?? "")}${focusTag}</td>
                <td>${escapeHtml(t.category_name ?? "")}</td>
                <td>${escapeHtml(t.due_date ?? "")}</td>
                <td>${escapeHtml(t.weight ?? "")}</td>
              </tr>
            `;
          }
        }
      });

      setStats({ focusCount });
      renderCalendar(taskEvents, eventEvents);

    } catch (err) {
      showError(err.message || "Load error");
      setStats({ focusCount: 0 });

      // still render empty calendar so UI doesn't look broken
      renderCalendar([], []);
    }
  }

  // Create Task (unchanged)
  $("#btnCreateTask").addEventListener("click", async () => {
    clearError();

    const payload = {
      task_name: ($("#newTaskName").value || "").trim(),
      category_name: $("#newTaskCategory").value,
      description: $("#newTaskDesc").value || "",
      due_date: $("#newTaskDue").value || null,
      weight: Number($("#newTaskWeight").value),
      todays_focus: $("#newTaskFocus").checked
    };

    if (!payload.task_name) { showError("Task name is required."); return; }
    if (!payload.category_name) { showError("Category is required."); return; }

    $("#btnCreateTask").disabled = true;

    try {
      const res = await fetch(strBaseURL + "tasks", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        let msg = "Failed to create task";
        try { msg = (await res.json()).detail || msg; } catch {}
        throw new Error(msg);
      }

      bootstrap.Modal.getInstance(document.getElementById("modalNewTask")).hide();

      $("#newTaskName").value = "";
      $("#newTaskDesc").value = "";
      $("#newTaskDue").value = "";
      $("#newTaskWeight").value = "3";
      setSunToggle($("#newTaskFocusBtn"), $("#newTaskFocus"), false);

      loadDashboard();

    } catch (err) {
      showError(err.message || "Create task error");
    } finally {
      $("#btnCreateTask").disabled = false;
    }
  });

  // Modals: load categories on show
  document.getElementById("modalNewTask").addEventListener("show.bs.modal", async () => {
    await loadCategoriesForModals();
    setSunToggle($("#newTaskFocusBtn"), $("#newTaskFocus"), false);
  });

  // Reload
  $("#btnReload").addEventListener("click", loadDashboard);

  setViewMode("dashboard");
  loadDashboard();
</script>
</body>
</html>